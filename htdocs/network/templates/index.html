{{% BLOCKS }}
{{< layout }}{>}
	{{$ title }}{{page.title}}{{/ title }}

	{{$ stylesheets }}
	<link href="{{ vars.home_path }}/css/lightbox.css" rel="stylesheet" />
	{{/ stylesheets }}

	{{$ more_scripts }}
	<script src="{{ vars.home_path }}/js/lightbox.min.js"></script>
	<script type='text/javascript' src='{{vars.home_path}}/js/fileupload.js'></script>
	<script type='text/javascript' src='{{vars.home_path}}/js/post-wall.js'></script>

	<script>
		/*
		$(function() {
		$( "#datetimepicker" ).datetimepicker();
		});
		 */
		function toggleEventForm(){
			if (document.getElementById("event-maker")) {
				var elem = document.getElementById("event-maker");
				if (elem.style.display == "none" || elem.style.display == "")
				{
					elem.style.display = "block";
					$("#event-post").text("Cancel");
				}
				else if (elem.style.display == "block") {
					elem.style.display = "none";
					$("#event-post").text("Post Event");
				}
			}
		}
	</script>
	{{/ more_scripts }}

	{{$ autoload_scripts }}
	<script type='text/javascript'> 
			{{# page_vars.member }}
			/*
			cm.Autoloader(function() {
					var psub = new cm.PostSubmit({
						form: document.getElementById('post-form'), 
						action: '{{vars.home_path}}/network_post.php',
						ajax: true,
						onSuccess: function(data) {
								var result = JSON.parse(data);
					       			img = document.getElementById('result_img');
								img.src = result.name;
							}
						}, 
						new cm.FileUploader({
						element: document.getElementById('post-form'),
						maxFiles: 3,
						acceptedFileTypes: ['jpg', 'png', 'gif', 'bmp', 'jpeg'],
						sizeLimit: 2097152
						}))
					});
					*/

			cm.Autoloader(function() {
					var wall = new cm.PostWall({
							wallUl : document.getElementById('post-wall-ul'),
							postSubmit : new cm.PostSubmit({
								form: document.getElementById('post-form'), 
								action: '{{vars.home_path}}/network_post.php',
								ajax: true
								},
								new cm.FileUploader({
								element: document.getElementById('post-form'),
								maxFiles: 3,
								acceptedFileTypes: ['jpg', 'png', 'gif', 'bmp', 'jpeg'],
								sizeLimit: 2097152
								})
							)
						})
					});

			cm.Autoloader(function() {
					var text = "You can use bold, italics, or links, "
					+ "just use the [b], [i], or [link] tags.</br></br>"
					+ "[b]Example[/b] becomes <b>Example</b>.</br></br>"
					+ "[i]Example[/i] becomes <i>Example</i>.</br></br>"
					+ "[link]www.example.com[/link] becomes <a>www.example.com</a>."

					// click for popover
					$('button.help-tooltip').popover({
						content: text,
						html: true
						});
					});
			{{/ page_vars.member }}
	</script>
	{{/ autoload_scripts }}

	{{$ content }}
		{{# sections.event_modals }}
		{{{ . }}}
		{{/ sections.event_modals }}
	<div content>
		<div class="net-left">
			<div class="leftbar">
				{{{ sections.map_embed }}}
				<div class="tags"></div>
				<div class="suggestions">
					<h4 class="h-network">People who viewed this network also viewed:</h4>
				</div>
			</div>
		</div>
		<div class="net-right">
			{{{ sections.searchbar }}}
			{{{ sections.lrgnetwork }}}
			<div>
				<div class='net-info'>
					<h1 class='h-network'>{{ sections.network_title }}</h1>
					<!-- TOTAL GUEST, NOT LOGGED IN -->
					{{^ logged_in }}
					<div class="guest">
						<p class='lrg-network-stats'>{{ page_vars.member_count }} Members | {{ page_vars.post_count }} Posts</p>
						<button class="network" onclick="$('#register_modal').modal('show');">Join us!</button>
					</div>
					{{/ logged_in }}
					<!-- LOGGED IN, VISITING THE NETWORK -->
					{{# logged_in }}
					{{^ page_vars.member }}
					<div class="reg-guest">
						<form method="POST" action="{{ vars.home_path }}/network_join.php">
							<p class='lrg-network-stats'>{{ page_vars.member_count }} Members | {{ page_vars.post_count }} Posts</p>
							<button class="network">Join us!</button>
						</form>
					</div>
					{{/ page_vars.member }}
					{{/ logged_in }}
					<!-- MEMBER OF THE NETWORK -->
					{{# page_vars.member }}
					<div class="member">
						<p class='lrg-network-stats'>{{ page_vars.member_count }} Members | {{ page_vars.post_count }} Posts</p>
						<form method="POST" action="{{ vars.home_path }}/network_leave.php">
							<button class="network">Leave Network</button>
							<input type="hidden" name="uid" value="{{ site_user.id }}"/>
							<input type="hidden" name="nid" value="{{ page_vars.nid }}"/>
						</form>
					</div>
					{{/ page_vars.member }}
					<div class="clear"></div>
					{{ vars.sharebuttons }}
					<div>
					<p class="network error" id="lnerror"></p>
					<p class="network error" id="jnerror"></p>
					</div>
				</div>
				<div class="clear"></div>
			</div>
			</br>
			<hr width="630">
			<!-------------- -->
			<ul class="nav nav-pills dashboard">
				<li id="post-nav" class="active"><a href="#post-wall" data-toggle="pill">Posts</a></li>
				<li id="event-nav"><a href="#event-wall" data-toggle="pill">Events</a></li>
			</ul>
			<!-------------- -->
			<div class="network tab-content">
			<div id="post-wall" class="tab-pane active">
				{{# page_vars.member }}
				<form id='post-form' method="POST" class="member fileupload-form" action="{{ vars.home_path }}/network_post.php" enctype="multipart/form-data">
					<img id="profile-post" src="{{ vars.img_host_repo}}/{{ site_user.img_link }}" width="45" height="45">
					<textarea class="post-text" name="post_text" placeholder="Post something..."></textarea>
					<button type="button" class="help-tooltip"  data-toggle="popover" data-placement="left">?</button>
					<div class="fileupload-error"></div>
					<div id='post-form-panel' class="fileupload-panel"></div>
					<div class="clear"></div>
					<div class="fileupload-button picture"></div>
					<input type="submit" class="network post fileupload-submit" value="Send"></input>
					<input type="hidden" name="post_class" value="o"></input>
					<input type="hidden" name="post_original" value="NULL"></input>
				</form>
				<hr>
				{{/ page_vars.member }}
				<!--
				<form method="POST" class="member" action="{{ vars.home_path }}/network_post.php">
				<img id="profile-post" src="{{ user.img_link }}" width="45" height="45">
					<textarea class="post-text" name="post_text" placeholder="Post something..."></textarea>
					<div class="clear"></div>
					<input type="submit" class="network post" value="Send"></input>
					<input type="hidden" name="post_class" value="o"></input>
					<input type="hidden" name="post_original" value="NULL"></input>
				</form>
				-->
				<ul id="post-wall-ul" class="network">
				{{# sections.posts }}
				{{{.}}}
				{{/ sections.posts }}
				</ul>
				{{# page_vars.more_posts }}
				<div>
					<form class="more_posts" method="POST" action="{{ vars.home_path }}/network_more_posts.php">
						<input type="hidden" id="nmp_lb" name="lb" value=10 />
						<input type="hidden" id="nmp_ub" name="ub" value=10 />
						<input type="hidden" id="nmp_nid" name="nid" value="{{ page_vars.nid }}" />
						<button id="mp_button" class="post show">Load Older Posts</button>
					</form>
				</div>
				{{/ page_vars.more_posts }}
				{{# get.ap }} lambda required
				{{/ get.ap }}
				<!--<script src="js/post-wall.js"></script>-->
				<script>
				/*
				var wall = document.getElementById("post-wall-ul");
					var postData;
					var grabData = function(data) {
						postData = data;
						replyPosts = [];
						for (var i = 0; i < postData.length; i++) {
							if (postData[i]['post_class'] == 'o')
							  { wall.appendChild(createParent(postData, i)); }
						/*
							else 
							{ 
								origId = postData[i]['post_original'];
								if (replyPosts[origId] == undefined) {
									replyPosts[origId] = [];
									replyPosts[origId].push(postData[i];
								}
								else
								  { replyPosts[origId].push(postData); }
							}
						 *//*
						}
						// do something with replyPostslength data
						// add a div for reply
					}

					loadPostData({{ page_vars.nid }}, grabData);
				 */
				</script>
			</div>
			<div id="event-wall" class="tab-pane">
				<!--<ul class="network">-->
				<div>
						<button id="slider-left" class="slider-button"></button>
							{{# sections.event_slider }}
							{{{ . }}}
							{{/ sections.event_slider }}
						<button id="slider-right" class="slider-button"></button>
				</div>
				<div class="clear"></div>
				<!--</ul>-->
				{{# page_vars.member }}
				<div>
				<button id="event-post" class="network member" onclick="toggleEventForm()">Post Event</button>
				</div>
				<div class="clear"></div>
				{{/ page_vars.member }}
				{{# get.eperror }}
				<script>
				</script>
				{{/ get.eperror }}
				<div id="event-maker">
					<form class="event-form" method="POST" action="{{ vars.home_path }}/network_post-event.php" enctype="multipart/form-data">
						<div>
						<input type="text" id="title" name="title" class="event-text" placeholder="Name of Event " required></input></br>
						<input type="text" id="datetimepicker1" name="datetime" class="event-text datetimepicker" placeholder="Event Date" required>
						<input type="text" class="hidden-field" name="date"></input>
						<input type="text" name="address_1" class="event-text" placeholder="Address 1" required/>
						<input type="text" name="address_2" class="event-text" placeholder="Address 2"/>
						<textarea id="description" name="description" class="event-text" placeholder="What's happening?" required></textarea>
						<div id="clear"></div>
						<input type="text" class="event-text" name="city" placeholder="City" required/></input>
						<input type="text" class="event-text" name="region" placeholder="Region" required/></input>
						<input type="submit" class="network" value="Post"></input>
						<span id="eperror">{{ get.eperror }}</span>
						</div>
					</form>
				</div>
			</div>
			</br>
			</br>

			</div>
			</br>
		</div>
		<div class="clear"></div>
	</div>
	{{/ content }}

	{{$ body_scripts }}
	<link rel="stylesheet" type="text/css" href="{{vars.home_path}}/js/jsdatetime/jquery.datetimepicker.css"/ >
	<script src="{{vars.home_path}}/js/jsdatetime/jquery.datetimepicker.js"></script>
	<script src="{{vars.home_path}}/js/searchbar.js"></script>
	<script src="{{vars.home_path}}/js/slider.js"></script>

	<script>
		$(".datetimepicker").datetimepicker();
	</script>	
	</script>
	<script>
		///// SHOW REPLY ///////////
		function primeShowReplies() {
			$(".show_reply").off("submit");
			$(".show_reply").on("submit", function(e) {
				e.preventDefault();
				// check if replies have already been fetched
				var replies_div = $( e.target ).parent().siblings('div.replies');

				var rd_children = $( replies_div ).children('ul').children();

				if ( rd_children.length <= 4 ) {
					var postForm = $(this).serialize();
					var getReply = new Ajax({
						requestType: 'POST',
						requestUrl: '{{ vars.home_path }}/network_show_reply.php',
							requestParameters: ' ',
							data: postForm,
							dataType: 'string',
							sendNow: true
					}, function(data) {
						// success function
						var response = JSON.parse(data);
						if (response.error == 0) {
							var targ = e.target;
							$( targ ).children(':submit').val('Hide Replies');
							$( targ ).parent().siblings('div.replies').children('ul').html(response.html);
							primeDeletes();
						}
					}, function(response, rStatus) {

					});
				}
				else {
					if ($( e.target ).children(':submit').val() == 'Hide Replies') {
						$( replies_div ).hide();
						$( e.target ).children(':submit').val('Show Replies');
					}
					else {
						$( replies_div ).show();
						$( e.target ).children(':submit').val('Hide Replies');
						primeDeletes();
					}
				}
			});
		}

		/////////// REQUEST REPLY /////////
		function primeRequestReplies() {
			$(".request_reply").off("submit");
			$(".request_reply").on("submit", function(e) {
				e.preventDefault();
				var postForm = $(this).serialize();
				if( $( e.target ).children('button').text() == 'Reply') {
					var requestReply = new Ajax({
						requestType: 'POST',
						requestUrl: '{{ vars.home_path }}/network_request_reply.php',
							requestParameters: ' ',
							data: postForm,
							dataType: 'string',
							sendNow: true
					}, function(data) {
						// success function
						var response = JSON.parse(data);
						if (response.error == 0) {
							var targ = e.target;
							$( e.target ).parents('li.network-post').children('div.prompt').show();
							$( targ ).children('button').text('Cancel');
							$( targ ).parents('li.network-post').children('div.prompt').html(response.html);
							primeReplyForms();
						}
					}, function(response, rStatus) {

					});
				}
				else {
					$( e.target ).parents('li.network-post').children('div.prompt').hide();
					$( e.target ).children('button').text('Reply');
				}
			});
		}

		////////// SEND REPLY //////////////
		function primeReplyForms() {
			$( '.reply_form' ).off('submit');
			$( '.reply_form' ).on('submit', function(e) {
				// prevent default behavior
				e.preventDefault();
				// get target
				var targ = e.target;
				var postForm = $( targ ).serialize();

				var sendReply = new Ajax({
					requestType: 'POST',
					requestUrl: '{{ vars.home_path }}/network_post_reply.php',
						requestParameters: ' ',
						data: postForm,
						dataType: 'string',
						sendNow: true
				}, function(data) {
					// success function
					var response = JSON.parse(data);
					if (response.error == 0) {
						// get div
						var targ = e.target;

						// put all lis out on display
						$( targ ).parents( 'li.network-post' ).children('div.replies').children('ul').html(response.html);

						// activate showreplies button, change to hide replies 
						// get ul
						// if there are over 4 of them
						if( $( targ ).parents( 'li.network-post' ).children('div.replies').children('ul').children().length > 4) {
							$( targ ).parents( 'div.prompt' ).siblings( 'div.show_reply_div' ).children('form.show_reply').show();
							$( targ ).parents( 'div.prompt' ).siblings( 'div.show_reply_div' ).children('form.show_reply').children(':submit').val('Hide Replies');
						}

						// increment replies
						//  a) get reply count
						var replyCount = $( targ ).parents( 'div.prompt' ).siblings('div.replies').children('ul.replies').children().length;
						//  b) increment in obvious place
						$( targ ).parents( 'div.prompt' ).siblings( 'div.post-info' ).children('p.reply_count').text(replyCount + ' replies');
						//  c) increment in hidden submit
						$( targ ).parents( 'div.prompt' ).siblings( 'div.post-info' ).children('form.post_delete').children("input[name='replies']").val(replyCount)
						//  d) increment at top of page

						// activate delete buttons
						primeDeletes();

						// clear out reply thing and change text
						$( targ ).parents( 'div.prompt' ).siblings( 'div.post-info' ).children('div.reply-button').children('form.request_reply').children('button').text('Reply');
						$( targ ).parents( 'div.prompt' ).hide();
					}
				}, function(response, rStatus) {

				});
			});
		}


		////////// DELETE REPLY /////////////
		//
		//
		function primeDeletes() {
			// event handler
			$( '.delete_reply' ).off('submit');
			$( '.delete_reply' ).on('submit', function(e) {
				// prevent default behavior
				e.preventDefault();
				// get target

				if (confirm("Are you sure you want to delete this reply?")) {
					var targ = e.target;
					var postForm = $( targ ).serialize();

					var sendReply = new Ajax({
						requestType: 'POST',
						requestUrl: '{{ vars.home_path }}/network_reply_delete.php',
							requestParameters: ' ',
							data: postForm,
							dataType: 'string',
							sendNow: true
					}, function(data) {
						// success function
						var response = JSON.parse(data);
						
						if (response.error == 0) {
							// delete parent li
							// get form
							var targ = e.target;
							var ul = $( targ ).parents('ul.replies');

							$( targ ).parents('li.reply').remove();

							// delete whole post
							if (response.status == 'postdelete') {
								$( ul ).parents('li.network-post').remove();
							}
							else {
								//var children = ul.children();
								//var replyCount =  children.length;
								var replyCount = ul.children().length;
								// update reply counts elsewhere
								// post info div
								var div = $( ul ).parents('div.replies').siblings('div.post-info');

								//  1) hidden input on delete post
								$( div ).children('div.reply-button.delete').children('form.post_delete').children("input[name|='replies']").val(replyCount);
								//  2) reply count
								$( div ).children('p.reply_count').text(replyCount + ' replies');

								// update 
								// if ul is now less than 4...
								if ( replyCount <= 4 ) {
									// hide show replies form
									$( ul ).parents('div.replies').siblings('div.show_reply_div').children('form.show_reply').children(':submit').val('Show Replies');
									$( ul ).parents('div.replies').siblings('div.show_reply_div').children('form.show_reply').hide();

									/*
									$( div ).children('div.reply-button').children('form.show_reply').children(':submit').val('Show Replies');
									$( div ).children('div.reply-button').children('form.show_reply').hide();
						 			*/
								}	
							}
						}
					}, function(response, rStatus) {

					});
				}
			});
		}

		/////// DELETE POST ///////////////////
		$('.post_delete').on('submit', function(e) {
			// prevent default behavior 
			e.preventDefault();

			if (confirm("Are you sure you want to delete this post?")) {
				var postForm = $( e.target ).serialize();

				postDelete = new Ajax({
					requestType: 'POST',
					requestUrl: '{{ vars.home_path }}/network_post_delete.php',
						requestHeaders: ' ',
						data: postForm,
						dataType: 'string',
						sendNow: true
				}, function(data) {
					var response = JSON.parse(data);

					if (response.error == 0) {
						var targ = $( e.target );
						if (response.status == 'destroyed') {
							// remove li 
							targ.parents('li.network-post').remove();
							// decrement number of posts up top
						}

						if (response.status == 'wiped') {
							targ.parents('li.network-post').replaceWith(response.html);
							callPrimes();
						}
					}
				}, function(response, rStatus) {

				});
			}
		});


		function primeDeletePosts() {
			$('.post_delete').off('submit');
			$('.post_delete').on('submit', function(e) {
				// prevent default behavior 
				e.preventDefault();

				if (confirm("Are you sure you want to delete this post?")) {
					var postForm = $( e.target ).serialize();

					postDelete = new Ajax({
						requestType: 'POST',
						requestUrl: '{{ vars.home_path }}/network_post_delete.php',
							requestHeaders: ' ',
							data: postForm,
							dataType: 'string',
							sendNow: true
					}, function(data) {
						var response = JSON.parse(data);

						if (response.error == 0) {
							var targ = $( e.target );
							if (response.status == 'destroyed') {
								// remove li 
								targ.parents('li.network-post').remove();
								// decrement number of posts up top
							}

							if (response.status == 'wiped') {
								targ.parents('li.network-post').replaceWith(response.html);
								callPrimes();
							}
						}
					}, function(response, rStatus) {

					});
				}
			});
		}

		$('.more_posts').on('submit', function(e) {
			
			// prevent default
			e.preventDefault();

			// get form
			var targ = $(e.target);
			var postForm = $( targ ).serialize();
			
			var requestPosts = new Ajax({
					requestType: 'POST',
					requestUrl: '{{ vars.home_path }}/network_more_posts.php',
					requestHeaders: ' ',
					data: postForm,
					dataType: 'string',
					sendNow: true
			}, function(data) {
				var response = JSON.parse(data);
				// add stuff to post wall
				$("#post-wall-ul").append(response.html);

				// with new stuff, call primes
				callPrimes();

				if(response['continue'] == 'n') {
					$( targ ).hide();
				}
				else {
					$('#nmp_lb').val(response['lb']);
				}
				
			}, function() {
			});
		});

		function callPrimes() {
			primeShowReplies();
			primeRequestReplies();
			primeReplyForms();
			primeDeletes();
			primeDeletePosts();
			primeShowReplies();
		}

//		primeShowReplies();
//		primeRequestReplies();
		callPrimes();

		console.log("buttons");
	</script>
	<script>
		function switchTab() {
			// remove post active status
			$('#post-nav').removeClass('active');
			$('#post-wall').removeClass('active');

			// add event active status
			$('#event-nav').addClass('active');
			$("#event-wall").addClass('active');
		}
	</script>
	{{# get.eperror }}
	<script>
		switchTab();

		toggleEventForm();
		$('#eperror').goTo();
		$('#eperror').text('{{ get.eperror }}');
		
	</script>
	{{/ get.eperror }}
	<script>
		var qs = new QueryStringParser();
		if (qs.qsGet != null ) {

			if (qs.qsGet['lerror'] != undefined) {
				if (qs.qsGet['lerror'] == 'success') {
					$('#signout_panel').children('p').text('You are now logged in!');
					$('#signout_panel').show();
					$('#signout_panel').fadeOut(5000);
				}
			}
			if (qs.qsGet['rerror'] != undefined) {
				if (qs.qsGet['rerror'] == 'success') {
					$('#signout_panel').children('p').html('You are now registered! Click <a href="{{ vars.home_path }}/profile_edit.php">here</a> to see your profile page.');
					$('#signout_panel').show();
				}
			}
			if (qs.qsGet['lnerror'] != undefined) {
				$('#lnerror').text(qs.qsGet['lnerror']);
				$('#lnerror').fadeOut(5000);
			}
			if (qs.qsGet['jnerror'] != undefined) {
				$('#jnerror').text(qs.qsGet['jnerror']);
				$('#jnerror').fadeOut(5000);
			}
			if (qs.qsGet['ueerror']!= undefined) {
				var mid = qs.qsGet['eid'];
				switchTab();

				$('#event-modal-'+mid).modal('show');
				$('#ueerror-'+mid).text(qs.qsGet['ueerror']);
			}
			if (qs.qsGet['jeerror']!= undefined) {
				var mid = qs.qsGet['eid'];
				switchTab();

				$('#event-modal-'+mid).modal('show');
				$('#jeerror-'+mid).text(qs.qsGet['jeerror']);
			}
			if (qs.qsGet['elink']!= undefined) {
				switchTab();		
				$('#event-modal-'+ qs.qsGet['elink']).modal('show');

			}
			if (qs.qsGet['leerror'] != undefined) {
				var mid = qs.qsGet['eid'];
				switchTab();

				$('#event-modal-'+mid).modal('show');
				$('#leerror-'+mid).text(qs.qsGet['leerror']);
			}
		}
	</script>
	{{/ body_scripts }}

{{/ layout }}
